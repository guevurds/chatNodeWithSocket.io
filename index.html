<!DOCTYPE html>
<html>
    <head>
        <title> chatLeigo</title>

        <style>
            #NumberOnline {
                color: greenyellow;
                font-size: 20pt;
            }

            .enviada {
                color: white;
                background-color: blue;
                margin-top: 5px;
                margin-bottom: 5px;
                border-radius: 14px;
                padding: 6px 6px;
                margin-right: 5px;
                margin-left: 75px;
            }

            .recebida{
                color: white;
                background-color: black;
                margin-top: 5px;
                margin-bottom: 5px;
                border-radius: 14px;
                padding: 0px 6px;
                margin-left: 5px;
                margin-right: 75px;
            }

            span {
                font-weight: bold;
                font-size: 13pt;
            }

            .somida {
                display: none;
            }

            #interfaceChat{
                background-color:rgba(0,0,0, 0.6);
                width: 500px;
                height: 555px;
            }

            #chat {
                border:black 1px solid;
                width: 100%;
                height: 500px;
                background-color: #ccc;
                overflow-x:hidden;
                overflow-y: auto;
                box-sizing: border-box;
            }

            #campo {
                width: 100%;
                box-sizing: border-box;
                background-color:rgba(29, 26, 26, 0.1);
                color: white;
            }

            #InformarNick {
                width: 500px;
                height: 555px;
                background-color: black;
                position: absolute;
                box-sizing: border-box;
                padding-left: 25px;
                padding-right: 25px;
                padding-top: 150px;
            }

            #campoDoNick {
                position: absolute;
                margin: 0px;
                bottom: 250px;
                width: 90%;
                font-size: 20pt;
                background-color: black;
                color: white;
                border: white solid 3px;
                border-radius: 10px;
                box-sizing: border-box;
            }

            #titulo {
                color: white;
                text-align: center;
                font-size: 40pt;
            }

            /* scrollBar */
            ::-webkit-scrollbar {
                width: 10px;
            }

            ::-webkit-scrollbar-track {
                background-color: rgba(0, 0, 0, 0.1);
                border-radius: 20px;
            }

            ::-webkit-scrollbar-thumb {
                background-color: rgba(0,0,0, 0.5);
                border-radius: 5px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background-color: rgba(0,0,0, 1);
            }


        </style>
    
        <script src="/socket.io/socket.io.js"></script>
        
    </head>
    <body>

        <div id= 'interfaceChat'>
            <div id='NumberOnline'>  </div>
            <div id="chat"></div>
            <form id="formulario">
                <input type="text" id="campo" autocomplete="off">
            </form>
        </div>

        <div id='InformarNick'> 
            <h1 id="titulo"> Digite Seu Nick: </h1>
            <form id="formDoNick">
                <input type="text" id="campoDoNick" autocomplete="off">
            </form>
        </div>
        

        


        <script type='module'> 
            // declaração de variaveis

            const interfaceChat = document.getElementById('interfaceChat');

                const divNumberOnline = document.getElementById('NumberOnline');

                const chat = document.getElementById('chat');

                    const formulario = document.getElementById('formulario');
                    const campo = document.getElementById('campo');
            
                const formDoNick = document.getElementById('formDoNick');
                const campoDoNick = document.getElementById('campoDoNick');
            

            const socket = io();

            const player = {
                id: null,
                name: null,
            }

            let conectados = []

            //verificar e validar

            function verificarNickname() {
                const InformarNick = document.getElementById('InformarNick');
                if(player.name != null) {
                    interfaceChat.classList.remove('somida');
                    InformarNick.style.display = 'none';
                    chat.scrollTop = chat.scrollHeight;
                } else {
                    interfaceChat.classList.add('somida');
                    // InformarNick.classList.remove('somida');
                    requestAnimationFrame(verificarNickname)
                }
                
            } 
            verificarNickname()

            // logs inicias

            socket.on ('connect', () => {
                console.log('connected: ' + socket.id);
                player.id = socket.id;
            });

            socket.on('qlogados', numeroConexoes => {
                console.log(numeroConexoes.length);
                conectados = numeroConexoes
                console.log('atualiza logados');
            })

            // estetica
            function updateThingsOfClient() {
                divNumberOnline.innerHTML = 'Online: '+ conectados.length;

                

                requestAnimationFrame(updateThingsOfClient)
            }
            updateThingsOfClient()

            // mensagem enviado ao servidor


                    addEventListener('submit', e => {
                    e.preventDefault();
                    console.log('oi1');
                    if (player.name != null) {
                            if (campo.value) {
                                if(campo.value.length <= 55) {
                                    const mensagem = {
                                        id: player.id,
                                        name: player.name,
                                        val: campo.value
                                    }

                                    console.log(campo.value.length)

                                    campo.value = null;

                                    

                                    socket.emit('newMessage', mensagem)
                        
                                } else {
                                    alert('sua mensagem tem ' +  campo.value.length +' caracteres\nO limite é de 55')
                                }
                        }    

                    }
                        if (player.name == null) {
                            if (campoDoNick.value.length <= 24) {
                                player.name = campoDoNick.value;
                            } else {
                                alert('seu nick tem ' + campoDoNick.value.length + 'caracteres\nO limite é 24')
                            }
                            
                        }
                })
                    

            

            // mensagem recebida do servidor
            socket.on ('atualizaChat', msm => {
                let element = document.createElement('div');
                element.innerHTML = "<span>" + msm.name + "</span><br> " + msm.val;

                if(msm.id == player.id) {
                    element.classList.add('enviada');
                    element.innerHTML = msm.val;
                } else {
                    element.classList.add('recebida');
                }

                chat.append(element);
                chat.scrollTop = chat.scrollHeight;
            })

            //receber o estado do chat 
            socket.on ('estadoDoChat', mensagens => {
                console.log('recebendo estado')
                console.log(mensagens)
                for(let msm of mensagens) {
                
                    let element = document.createElement('div');
                    element.classList.add('recebida');
                    element.innerHTML ="<span>"+ msm.name + "</span><br> " + msm.val;
                    chat.append(element)
                    
                    chat.scrollTop = chat.scrollHeight;
                }
            })


        </script>
    </body>
</html>